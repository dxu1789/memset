<!DOCTYPE html>
<html>
<head>
    <title>SET Memory Game</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding: 20px; background: #121212; color: #eee; gap: 20px; }
        
        .history { width: 180px; background: #1e1e1e; border: 2px solid #333; padding: 10px; height: 90vh; overflow-y: auto; transition: 0.3s; border-radius: 8px; }
        .history.active { border-color: #ff9800; background: #2a241a; box-shadow: 0 0 15px rgba(255, 152, 0, 0.2); }
        
        .history-group { 
            display: flex; 
            flex-direction: row; 
            justify-content: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #333;
        }

        #turn-display { font-size: 24px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; text-align: center; }
        .turn-p1 { color: #ff5252; }
        .turn-p2 { color: #e040fb; }

        #board { display: grid; grid-template-columns: repeat(4, 110px); gap: 10px; }
        
        .card { 
            width: 100px; height: 150px; border: 2px solid #444; border-radius: 8px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            cursor: pointer; background: #fff; position: relative;
        }
        
        .card.hidden { background: #2c3e50; border-color: #1a252f; }
        .card.selected { border-color: #ff9800 !important; box-shadow: 0 0 10px #ff9800; }
        
        /* Fixed Hint Glow */
        .card.hint-active { 
            border-color: #007bff !important; 
            box-shadow: 0 0 20px #007bff, inset 0 0 10px #007bff !important; 
        }
        
        .history .card { transform: scale(0.35); margin: 0 -28px; pointer-events: none; border-color: #444; flex-shrink: 0; }
        
        svg { width: 80px; height: 40px; overflow: visible; }
        .controls { text-align: center; margin-bottom: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 0 5px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }
        button:hover { background: #444; }
    </style>
</head>
<body>
    <div id="p1-history" class="history"><h3>P1 Sets</h3></div>

    <div id="game-container">
        <div class="controls">
            <div id="turn-display">Player 1's Turn</div>
            <button onclick="socket.emit('getHint')">Hint</button>
            <button onclick="socket.emit('reset')">New Game</button>
        </div>
        <div id="board"></div>
    </div>

    <div id="p2-history" class="history"><h3>P2 Sets</h3></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let lastState = null;
        let activeHintIds = [];

        const paths = {
            oval: '<rect x="10" y="7" width="80" height="36" rx="18" />',
            diamond: '<polygon points="50,5 95,25 50,45 5,25" />',
            squiggle: '<path d="M10,25 C10,0 35,0 55,14 S90,0 90,25 S65,50 45,36 S10,50 10,25 Z" />'
        };
        const colors = ['#f00', '#0a0', '#808'];

        function drawCard(card, isSelected) {
            const el = document.createElement('div');
            const isHinted = activeHintIds.includes(card.id);
            
            if (card.hidden) {
                el.className = 'card hidden' + (isHinted ? ' hint-active' : '');
                el.onclick = () => {
                    activeHintIds = []; 
                    socket.emit('selectCard', { cardId: card.id });
                };
                return el;
            }

            const path = [paths.oval, paths.diamond, paths.squiggle][card.s];
            const color = colors[card.c];
            const patternId = `s-${card.c}-${card.id}`;
            let fill = card.f === 0 ? color : (card.f === 2 ? 'none' : `url(#${patternId})`);
            
            let shapes = '';
            for(let i=0; i<card.n; i++) {
                shapes += `<svg viewBox="0 0 100 50">
                    <defs><pattern id="${patternId}" patternUnits="userSpaceOnUse" width="4" height="4" patternTransform="rotate(90)"><line x1="0" y1="0" x2="0" y2="4" stroke="${color}" stroke-width="2"/></pattern></defs>
                    <g fill="${fill}" stroke="${color}" stroke-width="3">${path}</g>
                </svg>`;
            }

            el.className = 'card' + (isSelected ? ' selected' : '') + (isHinted ? ' hint-active' : '');
            el.innerHTML = shapes;
            el.onclick = () => {
                activeHintIds = [];
                socket.emit('selectCard', { cardId: card.id });
            };
            return el;
        }

        function updateUI(s) {
            if (!s) return;
            lastState = s;
            const b = document.getElementById('board');
            const t = document.getElementById('turn-display');
            b.innerHTML = '';
            
            t.innerText = (s.activePlayer === 'p1' ? "Player 1" : "Player 2") + "'s Turn";
            t.className = s.activePlayer === 'p1' ? 'turn-p1' : 'turn-p2';
            
            document.getElementById('p1-history').classList.toggle('active', s.activePlayer === 'p1');
            document.getElementById('p2-history').classList.toggle('active', s.activePlayer === 'p2');

            s.board.forEach(c => {
                const isSelected = s.selected.some(sel => sel.id === c.id);
                b.appendChild(drawCard(c, isSelected));
            });
            
            ['p1', 'p2'].forEach(player => {
                const h = document.getElementById(`${player}-history`);
                h.innerHTML = `<h3>${player.toUpperCase()} Sets</h3>`;
                s[`player${player.slice(1)}Sets`].forEach(set => {
                    const group = document.createElement('div');
                    group.className = 'history-group';
                    set.forEach(c => group.appendChild(drawCard(c, false)));
                    h.appendChild(group);
                });
            });
        }

        socket.on('gameState', (s) => {
            if (!lastState || JSON.stringify(s.board) !== JSON.stringify(lastState.board)) {
                activeHintIds = [];
            }
            updateUI(s);
        });

        socket.on('hint', (ids) => {
            if (ids && ids.length > 0) {
                activeHintIds = ids;
                updateUI(lastState); 
            } else {
                alert("No SETs available!");
            }
        });
    </script>
</body>
</html>
