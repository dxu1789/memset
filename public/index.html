<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>memset | Multiplayer SET</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg: #1a1a1a;
            --card-front: #ffffff;
            --card-back: #2c3e50;
            --accent: #3498db;
        }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        #ui { text-align: center; margin-bottom: 20px; }
        #board { display: grid; grid-template-columns: repeat(4, 120px); gap: 15px; perspective: 1000px; }
        .card { width: 120px; height: 170px; cursor: pointer; position: relative; border-radius: 12px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card.matched { visibility: hidden; pointer-events: none; }
        
        .front, .back { 
            position: absolute; width: 100%; height: 100%; 
            backface-visibility: hidden; border-radius: 12px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
        }
        .back { background-color: var(--card-back); border: 2px solid #34495e; }
        .front { background-color: var(--card-front); transform: rotateY(180deg); padding: 5px; box-sizing: border-box; }

        .hint-highlight {
            z-index: 10;
            box-shadow: 0 0 20px 10px #f1c40f !important;
            border-radius: 12px;
        }
        .hint-highlight .front {
            border: 4px solid #f1c40f !important;
        }
        
        svg { width: 100px; height: 45px; overflow: visible; margin: 2px; }
        #controls { margin-top: 25px; }
        button { padding: 12px 24px; font-weight: bold; color: white; background: var(--accent); border: none; border-radius: 6px; cursor: pointer; margin: 0 10px; }
    </style>
</head>
<body>
    <div id="ui">
        <h1 id="turn">Connecting...</h1>
        <div id="scores">P1: 0 | P2: 0</div>
    </div>
    <div id="board"></div>
    <div id="controls">
        <button onclick="socket.emit('requestHint')">Get Hint</button>
        <button onclick="socket.emit('resetGame')" style="background-color: #27ae60;">New Game</button>
    </div>

    <script>
        const socket = io();
        const board = document.getElementById('board');

        const paths = {
            oval: '<rect x="10" y="10" width="80" height="30" rx="15" />',
            diamond: '<polygon points="50,5 95,25 50,45 5,25" />',
            // Squiggle height increased by 20%
            squiggle: '<path d="M15,20 C15,2 40,2 50,20 S85,38 85,20 L85,30 C85,48 60,48 50,30 S15,12 15,30 Z" />'
        };

        function render(state) {
            board.innerHTML = '';
            state.currentCards.forEach((card, i) => {
                const el = document.createElement('div');
                el.className = 'card';
                if (state.flippedIndices.includes(i)) el.classList.add('flipped');
                if (state.matchedIndices.includes(i)) el.classList.add('matched');
                el.dataset.index = i;
                
                const patternId = `stripes-${i}`;
                const fillVal = card.filling === 'solid' ? card.color : (card.filling === 'striped' ? `url(#${patternId})` : 'none');

                let symbolsHtml = '';
                for(let n=0; n < card.number; n++) {
                    symbolsHtml += `
                        <svg viewBox="0 0 100 50">
                            <defs>
                                <pattern id="${patternId}" width="4" height="4" patternUnits="userSpaceOnUse" patternTransform="rotate(90)">
                                    <line x1="0" y1="0" x2="0" y2="4" stroke="${card.color}" stroke-width="2.5" />
                                </pattern>
                            </defs>
                            <g fill="${fillVal}" stroke="${card.color}" stroke-width="3" stroke-linejoin="round" stroke-linecap="round">
                                ${paths[card.shape]}
                            </g>
                        </svg>`;
                }

                el.innerHTML = `<div class="card-inner"><div class="back"></div><div class="front">${symbolsHtml}</div></div>`;
                el.onclick = () => socket.emit('cardClicked', i);
                board.appendChild(el);
            });
            document.getElementById('turn').innerText = `${state.currentPlayer.toUpperCase()}'s Turn`;
            document.getElementById('scores').innerText = `P1: ${state.scores.p1} | P2: ${state.scores.p2}`;
        }

        socket.on('init', render);
        
        socket.on('hintResult', (indices) => {
            if (!indices) return alert("No sets found!");
            indices.forEach(i => {
                const cardEl = document.querySelector(`[data-index="${i}"]`);
                if (cardEl) cardEl.classList.add('hint-highlight');
            });
            setTimeout(() => {
                document.querySelectorAll('.hint-highlight').forEach(el => el.classList.remove('hint-highlight'));
            }, 2000);
        });

        socket.on('syncFlip', (indices) => {
            document.querySelectorAll('.card').forEach((c, i) => {
                indices.includes(i) ? c.classList.add('flipped') : (!c.classList.contains('matched') && c.classList.remove('flipped'));
            });
        });

        socket.on('matchFound', (data) => {
            data.matched.forEach(i => document.querySelector(`[data-index="${i}"]`)?.classList.add('matched'));
            document.getElementById('scores').innerText = `P1: ${data.scores.p1} | P2: ${data.scores.p2}`;
        });

        socket.on('turnEnd', (data) => {
            setTimeout(() => {
                document.querySelectorAll('.card:not(.matched)').forEach(c => c.classList.remove('flipped'));
                document.getElementById('turn').innerText = `${data.currentPlayer.toUpperCase()}'s Turn`;
            }, 1000);
        });
    </script>
</body>
</html>